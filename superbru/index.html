<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Dan Travers - SuperBru</title>
    <meta name="description" content="Predict football match scores.">
    <meta name="author" content="Dan Travers">
    <link rel="stylesheet" type="text/css" href="/style.css">
    <link rel="icon" type="image/png" href="/dicon.png">
</head>
<body>
    <header>
        <h1><a href="/" class="home-link">Dan Travers</a></h1>
    </header>

    <nav>
        <a href="/superbru/" class="active">SuperBru</a>
        <a href="/books/">Books</a>
    </nav>

    <article>
        <h2>SuperBru</h2>
        <p>Calculate the scoreline with the highest expected SuperBru points.</p>

        <!-- Toggle Title -->
        <h3 onclick="toggleExplanation()" class="toggle-title">
            <span class="toggle-symbol">▶</span> How does this work?
        </h3>
        

        <!-- Hidden Explanation & Image -->
        <div id="toggle-content" class="toggle-container hidden">
            <p class="explanation-text">
                In the fantasy sports game SuperBru, you score points
                depending on how well you predict the score of a game, as governed by
                <a href="https://www.superbru.com/premierleague_predictor/how_to_play.php#tab=scoring" target="_blank" rel="noopener noreferrer">these rules</a>. <br><br>
                
                This tool takes user-inputted xG values to estimate the probabilities of different scorelines. This is done by modelling the scoring of goals with a Poisson distribution. <br><br>

                The best prediction for each combination of home and away xG is shown in the plot below. Curiously, no draw other than 0-0 is ever the best
                Superbru prediction. This stems from the fact that draws have fewer scorelines that are considered 'close' by the SuperBru scoring system than wins have. <br><br>
            </p>
            <img src="/superbru/xg_plot_1.png" alt="XG Prediction Graph" class="prediction-image">
        </div>


        <div class="football-score-container">
            <!-- Home xG Input -->
            <div class="team-selection">
                <label for="home-xg">Home xG:</label>
                <input type="number" id="home-xg" step="0.01" min="0" max="5" placeholder="0.00">
            </div>

            <!-- Away xG Input -->
            <div class="team-selection">
                <label for="away-xg">Away xG:</label>
                <input type="number" id="away-xg" step="0.01" min="0" max="5" placeholder="0.00">
            </div>

            <!-- Predict Button -->
            <div class="predict-container">
                <button id="predict-button">Calculate</button>
            </div>

            <!-- Error Message Container -->
            <div id="error-message" class="error-message" style="display:none;"></div>
        </div>

        <table id="prediction-table" style="display:none;">
            <tr>
                <td><strong>Home xG</strong></td>
                <td id="home-xg-display"></td>
            </tr>
            <tr>
                <td><strong>Away xG</strong></td>
                <td id="away-xg-display"></td>
            </tr>
            <tr>
                <td><strong>Best SuperBru Prediction</strong></td>
                <td id="best-prediction"></td>
            </tr>
        </table>


    </article>

    <script>
        // Lookup database - will be loaded from JSON file
        let predictionDatabase = null;

        // Helper function to round to 2 decimal places
        function roundToTwoDecimals(value) {
            return Math.round(value * 100) / 100;
        }

        // Helper function to validate and normalize xG value
        function validateAndNormalizeXg(value) {
            if (value === '' || value === null || value === undefined) {
                return null;
            }
            
            const numValue = parseFloat(value);
            
            if (isNaN(numValue)) {
                return null;
            }
            
            // Round to 2 decimal places
            const rounded = roundToTwoDecimals(numValue);
            
            // Check bounds
            if (rounded < 0 || rounded > 5) {
                return null;
            }
            
            return rounded;
        }

        // Helper function to reset the display
        function resetDisplay() {
            document.getElementById('prediction-table').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
        }

        // Helper function to show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Load the prediction database
        async function loadDatabase() {
            try {
                const response = await fetch('/superbru/predictions-db.json');
                if (!response.ok) {
                    throw new Error('Failed to load prediction database');
                }
                predictionDatabase = await response.json();
            } catch (error) {
                console.error('Error loading database:', error);
                showError('Error loading prediction database. Please refresh the page.');
            }
        }

        // Initialize the calculate button functionality
        document.getElementById('predict-button').addEventListener('click', function() {
            const homeXgInput = document.getElementById('home-xg').value;
            const awayXgInput = document.getElementById('away-xg').value;
            const predictButton = document.getElementById('predict-button');

            // Reset display
            resetDisplay();

            // Validate and normalize inputs
            const homeXg = validateAndNormalizeXg(homeXgInput);
            const awayXg = validateAndNormalizeXg(awayXgInput);

            // Check if both values are provided
            if (homeXg === null || awayXg === null) {
                showError('The xG values must be between 0.00 and 5.00.');
                return;
            }

            // Check if database is loaded
            if (!predictionDatabase) {
                showError('Prediction database not loaded. Please refresh the page.');
                return;
            }

            // Create lookup key (format: "homeXg_awayXg" with 2 decimal places)
            const key = `${homeXg.toFixed(2)}_${awayXg.toFixed(2)}`;
            
            // Lookup prediction
            const prediction = predictionDatabase[key];
            
            if (!prediction) {
                showError(`No prediction found for Home xG: ${homeXg.toFixed(2)}, Away xG: ${awayXg.toFixed(2)}`);
                return;
            }

            // Update table cells
            document.getElementById('home-xg-display').textContent = homeXg.toFixed(2);
            document.getElementById('away-xg-display').textContent = awayXg.toFixed(2);
            
            // Check if prediction indicates equal xG values
            const bestPredictionElement = document.getElementById('best-prediction');
            if (prediction.endsWith('|EQUAL')) {
                const basePrediction = prediction.replace('|EQUAL', '');
                // Reverse the scoreline for the alternative
                const [homeGoals, awayGoals] = basePrediction.split('-').map(Number);
                const reversedPrediction = `${awayGoals}-${homeGoals}`;
                // Display home team with higher goals first
                const firstPrediction = homeGoals >= awayGoals ? basePrediction : reversedPrediction;
                const secondPrediction = homeGoals >= awayGoals ? reversedPrediction : basePrediction;
                bestPredictionElement.innerHTML = `${firstPrediction} or ${secondPrediction}<br>Go with your gut!`;
            } else {
                bestPredictionElement.textContent = prediction;
            }

            // Show the table
            document.getElementById('prediction-table').style.display = 'table';
        });

        // Add event listeners for input changes to clear error messages
        document.getElementById('home-xg').addEventListener('input', resetDisplay);
        document.getElementById('away-xg').addEventListener('input', resetDisplay);

        // Load database on page load
        loadDatabase();
    </script>

    <script>
        // Function to toggle content visibility
        // Function to toggle content visibility and active class
        function toggleExplanation() {
            var content = document.getElementById("toggle-content");
            var title = document.querySelector(".toggle-title");
            var symbol = title.querySelector(".toggle-symbol"); // Correctly select the toggle symbol

            // Toggle the content visibility and the symbol
            if (content.style.display === "none" || content.style.display === "") {
                content.style.display = "block"; // Show content
                symbol.innerHTML = "▼"; // Change symbol to 'down' when the content is visible
                title.classList.add('active'); // Add active class to keep orange color
            } else {
                content.style.display = "none"; // Hide content
                symbol.innerHTML = "▶"; // Change symbol to 'right' when the content is hidden
                title.classList.remove('active'); // Remove active class when content is hidden
            }
        }

        // Hide the content on page load
        document.addEventListener('DOMContentLoaded', function() {
            var content = document.getElementById("toggle-content");
            content.style.display = "none"; // Ensure content is hidden on load
        });

    </script>
    
</body>
</html>
